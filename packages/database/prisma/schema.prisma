generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ORGANIZATION & WHITE-LABEL (Enterprise Multi-tenancy)
// ============================================================================

model Organization {
  id                   String    @id @default(uuid())
  name                 String
  slug                 String    @unique  // URL-safe identifier (e.g., "acme-corp")
  domain               String?   @unique  // Custom domain for white-label (e.g., "chat.acme.com")
  isActive             Boolean   @default(true)
  settings             Json      @default("{}")  // Feature flags, limits, quotas
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  branding             OrganizationBranding?
  members              OrganizationMember[]
  users                User[]
  characters           Character[]
  conversations        Conversation[]
  domainVerifications  DomainVerification[]

  @@index([slug])
  @@index([domain])
  @@index([isActive])
}

model OrganizationBranding {
  id                   String    @id @default(uuid())
  organizationId       String    @unique
  logoUrl              String?   // Main logo URL
  faviconUrl           String?   // Favicon URL
  primaryColor         String    @default("#6366f1")  // Brand primary color (Indigo-500)
  secondaryColor       String    @default("#8b5cf6")  // Brand secondary color (Violet-500)
  appName              String?   // Custom app name (defaults to org name if null)
  customCss            String?   // Custom CSS overrides (injected into head)
  welcomeMessage       String?   // Custom welcome/landing page message
  footerText           String?   // Custom footer text
  supportEmail         String?   // Custom support contact email
  metadata             Json      @default("{}")  // Additional branding options (fonts, etc.)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model OrganizationMember {
  id                   String    @id @default(uuid())
  organizationId       String
  userId               String
  role                 OrgMemberRole @default(MEMBER)
  invitedBy            String?   // User ID of who invited this member
  invitedAt            DateTime  @default(now())
  acceptedAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

enum OrgMemberRole {
  OWNER     // Full control, billing, can delete org
  ADMIN     // Manage members, branding, settings
  MEMBER    // Standard access within org
}

model DomainVerification {
  id                   String    @id @default(uuid())
  organizationId       String
  domain               String
  verificationToken    String    @unique  // Random token for DNS/file verification
  verificationMethod   DomainVerificationMethod @default(DNS_TXT)
  status               DomainVerificationStatus @default(PENDING)
  verifiedAt           DateTime?
  expiresAt            DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, domain])
  @@index([domain])
  @@index([verificationToken])
  @@index([status])
}

enum DomainVerificationMethod {
  DNS_TXT      // Add TXT record to DNS
  DNS_CNAME    // Add CNAME record pointing to platform
  META_TAG     // Add meta tag to website
  FILE_UPLOAD  // Upload verification file to /.well-known/
}

enum DomainVerificationStatus {
  PENDING      // Awaiting verification
  VERIFIED     // Successfully verified
  FAILED       // Verification attempt failed
  EXPIRED      // Verification expired
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  passwordHash         String?
  username             String    @unique
  displayName          String?
  avatarUrl            String?
  bio                  String?
  role                 UserRole  @default(USER)
  status               UserStatus @default(ACTIVE)
  credits              Int       @default(100)
  subscriptionTier     SubscriptionTier @default(FREE)
  subscriptionExpiresAt DateTime?
  emailVerified        Boolean   @default(false)
  emailVerifiedAt      DateTime?
  lastLoginAt          DateTime?
  organizationId       String?   // Optional: User belongs to an organization (white-label tenant)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  preferences          UserPreferences?
  oauthAccounts        OAuthAccount[]
  characters           Character[]
  conversations        Conversation[]
  favorites            Favorite[]
  ratings              CharacterRating[]
  subscriptions        Subscription[]
  creditTransactions   CreditTransaction[]
  refreshTokens        RefreshToken[]
  apiKeys              ApiKey[]
  organization         Organization? @relation(fields: [organizationId], references: [id])
  organizationMemberships OrganizationMember[]

  // Forum relations
  forumThreads         ForumThread[] @relation("ThreadAuthor")
  forumLastReplies     ForumThread[] @relation("ThreadLastReply")
  forumPosts           ForumPost[] @relation("ForumPostAuthor")
  forumReactions       ForumReaction[] @relation("ForumReactionUser")

  // Follow relations (Week 12 - Creator Following System)
  followers            Follow[] @relation("UserFollowers")   // Users who follow this user
  following            Follow[] @relation("UserFollowing")   // Users this user follows

  @@index([email])
  @@index([username])
  @@index([status])
  @@index([subscriptionTier])
  @@index([organizationId])
}

enum UserRole {
  USER
  CREATOR
  MODERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  UNLIMITED
}

model UserPreferences {
  id                   String    @id @default(uuid())
  userId               String    @unique
  theme                Theme     @default(SYSTEM)
  language             String    @default("en")
  notificationsEnabled Boolean   @default(true)
  emailNotifications   Boolean   @default(true)
  defaultChatMode      ChatMode  @default(STANDARD)
  contentFilter        ContentFilterLevel @default(MODERATE)
  autoSaveConversations Boolean  @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum ContentFilterLevel {
  STRICT
  MODERATE
  RELAXED
}

model OAuthAccount {
  id                   String    @id @default(uuid())
  userId               String
  provider             OAuthProvider
  providerAccountId    String
  accessToken          String?
  refreshToken         String?
  expiresAt            DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

enum OAuthProvider {
  GOOGLE
  DISCORD
  GITHUB
}

model RefreshToken {
  id                   String    @id @default(uuid())
  userId               String
  token                String    @unique
  expiresAt            DateTime
  isRevoked            Boolean   @default(false)
  userAgent            String?
  ipAddress            String?
  createdAt            DateTime  @default(now())

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================================================
// CHARACTER MANAGEMENT
// ============================================================================

model Character {
  id                   String    @id @default(uuid())
  creatorId            String
  organizationId       String?   // Optional: Character belongs to an organization (tenant isolation)
  name                 String
  tagline              String
  description          String
  avatarUrl            String?
  bannerUrl            String?
  systemPrompt         String
  greeting             String
  exampleDialogues     Json      @default("[]")
  traits               String[]  @default([])
  background           String    @default("")
  voice                VoiceStyle @default(CASUAL)
  responseLength       ResponseLength @default(MEDIUM)
  visibility           CharacterVisibility @default(PRIVATE)
  category             String
  tags                 String[]  @default([])
  rating               Float     @default(0)
  ratingCount          Int       @default(0)
  chatCount            Int       @default(0)
  messageCount         Int       @default(0)
  isFeatured           Boolean   @default(false)
  isNsfw               Boolean   @default(false)
  status               CharacterStatus @default(DRAFT)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Remix/Fork fields
  parentCharacterId    String?   // Original character this was remixed from
  isRemix              Boolean   @default(false)
  remixCount           Int       @default(0)  // Number of times this character has been remixed
  allowRemix           Boolean   @default(true)  // Creator can disable remixing

  // Relations
  creator              User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  organization         Organization? @relation(fields: [organizationId], references: [id])
  conversations        Conversation[]
  favorites            Favorite[]
  ratings              CharacterRating[]
  parentCharacter      Character?  @relation("CharacterRemixes", fields: [parentCharacterId], references: [id])
  remixes              Character[] @relation("CharacterRemixes")

  @@index([creatorId])
  @@index([organizationId])
  @@index([status, visibility])
  @@index([category])
  @@index([isFeatured])
  @@index([rating])
  @@index([chatCount])
  @@index([createdAt])
  @@index([parentCharacterId])
  @@index([isRemix])
}

enum VoiceStyle {
  FORMAL
  CASUAL
  PLAYFUL
  SERIOUS
  POETIC
  TECHNICAL
}

enum ResponseLength {
  SHORT
  MEDIUM
  LONG
  VARIABLE
}

enum CharacterVisibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum CharacterStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  BANNED
}

model CharacterRating {
  id                   String    @id @default(uuid())
  userId               String
  characterId          String
  rating               Int       // 1-5
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character            Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([characterId])
}

model Favorite {
  id                   String    @id @default(uuid())
  userId               String
  characterId          String
  createdAt            DateTime  @default(now())

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character            Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([userId, characterId])
  @@index([userId])
  @@index([characterId])
}

// ============================================================================
// CONVERSATION & MESSAGING
// ============================================================================

model Conversation {
  id                   String    @id @default(uuid())
  userId               String
  characterId          String
  organizationId       String?   // Optional: Conversation belongs to an organization (tenant isolation)
  title                String?
  mode                 ChatMode  @default(STANDARD)
  status               ConversationStatus @default(ACTIVE)
  messageCount         Int       @default(0)
  lastMessageAt        DateTime?
  parentConversationId String?
  branchPointMessageId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Sharing fields
  isPublic             Boolean   @default(false)
  shareToken           String?   @unique  // Random token for share URL
  sharedAt             DateTime?
  shareSettings        Json      @default("{}")  // { allowComments: bool, showUsername: bool }

  // Relations
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  character            Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  organization         Organization? @relation(fields: [organizationId], references: [id])
  messages             Message[]
  memories             MemoryEntry[]
  parentConversation   Conversation? @relation("ConversationBranches", fields: [parentConversationId], references: [id])
  branchedConversations Conversation[] @relation("ConversationBranches")
  branchPointMessage   Message?  @relation("BranchPoint", fields: [branchPointMessageId], references: [id])
  share                ConversationShare?

  @@index([userId])
  @@index([characterId])
  @@index([organizationId])
  @@index([status])
  @@index([lastMessageAt])
  @@index([createdAt])
  @@index([shareToken])
}

enum ChatMode {
  STANDARD
  ROLEPLAY
  ADVENTURE
  CREATIVE
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model ConversationShare {
  id             String    @id @default(cuid())
  conversationId String    @unique
  viewCount      Int       @default(0)
  lastViewedAt   DateTime?
  createdAt      DateTime  @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model Message {
  id                   String    @id @default(uuid())
  conversationId       String
  role                 MessageRole
  content              String
  tokenCount           Int       @default(0)
  isEdited             Boolean   @default(false)
  isRegenerated        Boolean   @default(false)
  parentMessageId      String?
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  conversation         Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  parentMessage        Message?  @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies              Message[] @relation("MessageReplies")
  branchedConversations Conversation[] @relation("BranchPoint")

  @@index([conversationId])
  @@index([createdAt])
  @@index([role])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================================================
// MEMORY SYSTEM
// ============================================================================

model MemoryEntry {
  id                   String    @id @default(uuid())
  conversationId       String
  type                 MemoryType
  content              String
  importance           Float     @default(0.5)
  embedding            Float[]   @default([])
  createdAt            DateTime  @default(now())
  expiresAt            DateTime?

  conversation         Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([type])
  @@index([importance])
  @@index([expiresAt])
}

enum MemoryType {
  FACT
  PREFERENCE
  EVENT
  RELATIONSHIP
  SUMMARY
}

// ============================================================================
// PAYMENT & SUBSCRIPTION
// ============================================================================

model Subscription {
  id                   String    @id @default(uuid())
  userId               String
  tier                 SubscriptionTier
  status               SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String
  stripeSubscriptionId String    @unique
  stripePriceId        String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

model CreditTransaction {
  id                   String    @id @default(uuid())
  userId               String
  type                 CreditTransactionType
  amount               Int
  balance              Int
  description          String
  referenceId          String?
  metadata             Json?
  createdAt            DateTime  @default(now())

  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum CreditTransactionType {
  PURCHASE
  USAGE
  REFUND
  BONUS
  SUBSCRIPTION
}

// ============================================================================
// CONTENT MODERATION
// ============================================================================

model ModerationLog {
  id                   String    @id @default(uuid())
  contentType          ModerationContentType
  contentId            String
  userId               String?
  action               ModerationAction
  reason               String?
  flags                Json?
  score                Float?
  reviewedBy           String?
  reviewedAt           DateTime?
  createdAt            DateTime  @default(now())

  @@index([contentType, contentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum ModerationContentType {
  MESSAGE
  CHARACTER
  USER_PROFILE
}

enum ModerationAction {
  APPROVED
  FLAGGED
  BLOCKED
  DELETED
  PENDING_REVIEW
}

// ============================================================================
// ANALYTICS (Basic)
// ============================================================================

model UsageMetric {
  id                   String    @id @default(uuid())
  userId               String?
  eventType            String
  eventData            Json?
  createdAt            DateTime  @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================================================
// API KEY MANAGEMENT (Enterprise Feature)
// ============================================================================

model ApiKey {
  id                   String    @id @default(cuid())
  userId               String
  name                 String
  keyHash              String    // bcrypt hashed key
  keyPrefix            String    // First 8 chars for display (e.g., "bos_live")
  scopes               Json      @default("[\"read\"]") // JSON array: ['read', 'write', 'admin']
  rateLimit            Int?      // Custom rate limit override (requests per minute)
  lastUsedAt           DateTime?
  createdAt            DateTime  @default(now())
  expiresAt            DateTime?
  isActive             Boolean   @default(true)
  description          String?

  // Relations
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyPrefix])
  @@index([isActive])
  @@index([expiresAt])
}

// ============================================================================
// COMMUNITY FORUMS (Week 12 Feature)
// ============================================================================

model ForumCategory {
  id                   String    @id @default(cuid())
  name                 String    @unique
  slug                 String    @unique
  description          String?
  icon                 String?   // Emoji or icon name (e.g., "ðŸ’¬" or "chat-bubble")
  sortOrder            Int       @default(0)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())

  // Relations
  threads              ForumThread[]

  @@index([slug])
  @@index([sortOrder])
}

model ForumThread {
  id                   String    @id @default(cuid())
  categoryId           String
  authorId             String
  title                String
  content              String    @db.Text
  isPinned             Boolean   @default(false)
  isLocked             Boolean   @default(false)
  viewCount            Int       @default(0)
  replyCount           Int       @default(0)
  lastReplyAt          DateTime?
  lastReplyById        String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  category             ForumCategory @relation(fields: [categoryId], references: [id])
  author               User @relation("ThreadAuthor", fields: [authorId], references: [id])
  lastReplyBy          User? @relation("ThreadLastReply", fields: [lastReplyById], references: [id])
  posts                ForumPost[]

  @@index([categoryId])
  @@index([authorId])
  @@index([isPinned, createdAt])
  @@index([lastReplyAt])
}

model ForumPost {
  id                   String    @id @default(cuid())
  threadId             String
  authorId             String
  content              String    @db.Text
  isEdited             Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  thread               ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author               User @relation("ForumPostAuthor", fields: [authorId], references: [id])
  reactions            ForumReaction[]

  @@index([threadId])
  @@index([authorId])
  @@index([createdAt])
}

model ForumReaction {
  id                   String    @id @default(cuid())
  postId               String
  userId               String
  type                 String    // 'like', 'helpful', 'funny'
  createdAt            DateTime  @default(now())

  // Relations
  post                 ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user                 User @relation("ForumReactionUser", fields: [userId], references: [id])

  @@unique([postId, userId, type])
  @@index([postId])
  @@index([userId])
}

// ============================================================================
// CREATOR FOLLOWING SYSTEM (Week 12 Feature)
// ============================================================================

model Follow {
  id          String   @id @default(cuid())
  followerId  String   // User who is following
  followingId String   // User being followed (creator)
  createdAt   DateTime @default(now())

  // Relations
  follower    User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================================================
// FRAUD DETECTION SYSTEM
// ============================================================================

// Device fingerprinting and session tracking
model DeviceFingerprint {
  id                   String    @id @default(uuid())
  fingerprintHash      String    @unique  // Hash of collected signals
  userAgent            String?
  screenResolution     String?
  timezone             String?
  language             String?
  platform             String?
  webglRenderer        String?
  canvasHash           String?   // Canvas fingerprint
  audioHash            String?   // AudioContext fingerprint
  fonts                String[]  @default([])
  plugins              String[]  @default([])
  firstSeenAt          DateTime  @default(now())
  lastSeenAt           DateTime  @updatedAt

  // Relations
  sessions             UserSession[]

  @@index([fingerprintHash])
  @@index([firstSeenAt])
}

model UserSession {
  id                   String    @id @default(uuid())
  userId               String
  deviceFingerprintId  String?
  ipAddress            String
  ipCountry            String?
  ipCity               String?
  ipAsn                String?   // Autonomous System Number (ISP/hosting)
  isVpn                Boolean   @default(false)
  isProxy              Boolean   @default(false)
  isDatacenter         Boolean   @default(false)
  isTor                Boolean   @default(false)
  startedAt            DateTime  @default(now())
  endedAt              DateTime?
  lastActivityAt       DateTime  @default(now())

  // Behavioral metrics (updated in real-time)
  messageCount         Int       @default(0)
  avgTypingSpeedMs     Float?    // Average ms between keystrokes
  avgResponseTimeMs    Float?    // Average ms to respond to AI
  avgMessageLength     Float?
  uniqueCharacters     Int       @default(0)  // Distinct characters chatted with

  // Risk assessment
  riskScore            Float     @default(0)
  riskFactors          Json      @default("[]")

  // Relations
  deviceFingerprint    DeviceFingerprint? @relation(fields: [deviceFingerprintId], references: [id])
  events               FraudEvent[]

  @@index([userId])
  @@index([deviceFingerprintId])
  @@index([ipAddress])
  @@index([startedAt])
  @@index([riskScore])
}

// Granular interaction tracking for fraud analysis
model InteractionEvent {
  id                   String    @id @default(uuid())
  sessionId            String
  userId               String
  characterId          String
  creatorId            String    // Denormalized for query efficiency
  conversationId       String
  eventType            InteractionEventType

  // Timing data
  timestamp            DateTime  @default(now())
  messageLength        Int?
  typingDurationMs     Int?      // How long user typed
  timeSinceLastMessage Int?      // Ms since last message in conversation

  // Context
  hourOfDay            Int       // 0-23
  dayOfWeek            Int       // 0-6
  isWeekend            Boolean

  @@index([userId, timestamp])
  @@index([characterId, timestamp])
  @@index([creatorId, timestamp])
  @@index([sessionId])
  @@index([eventType])
}

enum InteractionEventType {
  MESSAGE_SENT
  MESSAGE_RECEIVED
  CONVERSATION_STARTED
  CONVERSATION_ENDED
  CHARACTER_FAVORITED
  CHARACTER_RATED
}

// Aggregated metrics for batch analysis
model CreatorMetricsDaily {
  id                   String    @id @default(uuid())
  creatorId            String
  date                 DateTime  @db.Date

  // Volume metrics
  totalMessages        Int       @default(0)
  totalConversations   Int       @default(0)
  uniqueUsers          Int       @default(0)
  totalDurationMinutes Int       @default(0)

  // Quality metrics
  avgMessagesPerConv   Float     @default(0)
  avgConvDurationMin   Float     @default(0)
  returnUserRate       Float     @default(0)  // % users who came back

  // Suspicious activity counts
  singleMsgConvs       Int       @default(0)  // Conversations with only 1 user msg
  rapidFireSessions    Int       @default(0)  // Sessions with > 100 msgs/hour
  newAccountInteracts  Int       @default(0)  // Interactions from < 24hr accounts
  sameIpUsers          Int       @default(0)  // Unique users from same IP
  sameFingerprintUsers Int       @default(0)  // Unique users from same device

  // Revenue attribution
  revenueAttributed    Int       @default(0)  // Cents

  // Anomaly scores (computed by ML)
  volumeAnomalyScore   Float?
  patternAnomalyScore  Float?
  networkAnomalyScore  Float?
  overallRiskScore     Float?

  @@unique([creatorId, date])
  @@index([creatorId])
  @@index([date])
  @@index([overallRiskScore])
}

// User-to-User relationship graph for collusion detection
model UserRelationship {
  id                   String    @id @default(uuid())
  userAId              String
  userBId              String
  relationshipType     UserRelationType
  strength             Float     @default(0)  // 0-1 score

  // Shared attributes
  sharedIpAddresses    String[]  @default([])
  sharedDevices        String[]  @default([])
  sharedPaymentMethods String[]  @default([])
  mutualCharacters     String[]  @default([])  // Characters both interact with

  firstDetectedAt      DateTime  @default(now())
  lastUpdatedAt        DateTime  @updatedAt

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
  @@index([relationshipType])
  @@index([strength])
}

enum UserRelationType {
  SAME_DEVICE       // Same device fingerprint
  SAME_IP           // Same IP address
  SAME_NETWORK      // Same /24 subnet or ASN
  PAYMENT_LINKED    // Shared payment method
  BEHAVIORAL_MATCH  // Similar behavioral patterns
  TEMPORAL_MATCH    // Always active at same times
  CREATOR_FAN       // One is creator, other fans their characters
}

// Fraud investigation cases
model FraudCase {
  id                   String    @id @default(uuid())
  caseNumber           String    @unique  // Human-readable: FRD-2024-00001
  status               FraudCaseStatus @default(OPEN)
  priority             FraudCasePriority @default(MEDIUM)

  // Subject(s)
  primaryUserId        String
  relatedUserIds       String[]  @default([])
  relatedCharacterIds  String[]  @default([])

  // Detection info
  detectionMethod      String    // "realtime_velocity", "batch_pattern", "ml_anomaly"
  triggerEventId       String?   // Original event that triggered
  triggerRuleId        String?   // Rule that was violated

  // Risk assessment
  initialRiskScore     Float
  currentRiskScore     Float
  estimatedImpact      Int       @default(0)  // Cents of potential fraud

  // Evidence
  evidenceSummary      String?   @db.Text
  evidenceData         Json      @default("{}")

  // Timeline
  detectedAt           DateTime  @default(now())
  assignedAt           DateTime?
  assignedTo           String?   // Admin user ID
  resolvedAt           DateTime?
  resolution           FraudCaseResolution?
  resolutionNotes      String?   @db.Text

  // Relations
  actionsTaken         FraudAction[]
  appeal               FraudAppeal?

  @@index([status])
  @@index([priority])
  @@index([primaryUserId])
  @@index([detectedAt])
  @@index([assignedTo])
}

enum FraudCaseStatus {
  OPEN
  INVESTIGATING
  PENDING_REVIEW
  RESOLVED
  APPEALED
  CLOSED
}

enum FraudCasePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FraudCaseResolution {
  CONFIRMED_FRAUD
  SUSPECTED_FRAUD
  FALSE_POSITIVE
  INSUFFICIENT_EVIDENCE
  POLICY_VIOLATION
}

// Actions taken in response to fraud
model FraudAction {
  id                   String    @id @default(uuid())
  caseId               String
  actionType           FraudActionType
  targetUserId         String?
  targetCharacterId    String?

  // Details
  severity             String    // "warning", "temporary", "permanent"
  duration             Int?      // Duration in hours for temporary actions
  reason               String

  // Execution
  isAutomated          Boolean   @default(false)
  executedAt           DateTime  @default(now())
  executedBy           String?   // Admin user ID or "system"
  reversedAt           DateTime?
  reversedBy           String?
  reverseReason        String?

  // Relations
  case                 FraudCase @relation(fields: [caseId], references: [id])

  @@index([caseId])
  @@index([targetUserId])
  @@index([actionType])
  @@index([executedAt])
}

enum FraudActionType {
  REVENUE_HOLD          // Hold pending payouts
  REVENUE_CLAWBACK      // Reverse attributed revenue
  RATE_LIMIT            // Stricter rate limits
  SHADOW_BAN            // Don't count toward revenue
  TEMPORARY_SUSPEND     // Temporary account suspension
  PERMANENT_BAN         // Permanent ban
  PAYOUT_BLOCK          // Block future payouts
  WARNING_ISSUED        // Just a warning
  MONITORING_INCREASED  // Flag for closer monitoring
}

// Appeal process
model FraudAppeal {
  id                   String    @id @default(uuid())
  caseId               String    @unique
  appealNumber         String    @unique  // APL-2024-00001
  status               AppealStatus @default(SUBMITTED)

  // Appellant info
  userId               String
  contactEmail         String

  // Appeal content
  appealReason         String    @db.Text
  supportingEvidence   Json      @default("[]")  // Links, screenshots, etc.

  // Process
  submittedAt          DateTime  @default(now())
  acknowledgedAt       DateTime?
  reviewStartedAt      DateTime?
  reviewerId           String?

  // Internal notes (not visible to appellant)
  internalNotes        String?   @db.Text

  // Decision
  decision             AppealDecision?
  decisionReason       String?   @db.Text
  decidedAt            DateTime?
  decidedBy            String?

  // Follow-up
  compensationOffered  Int?      // Cents
  compensationAccepted Boolean?

  // Relations
  case                 FraudCase @relation(fields: [caseId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}

enum AppealStatus {
  SUBMITTED
  ACKNOWLEDGED
  UNDER_REVIEW
  ADDITIONAL_INFO_REQUESTED
  DECIDED
  CLOSED
}

enum AppealDecision {
  UPHELD            // Original decision stands
  OVERTURNED        // Fraud finding reversed
  PARTIALLY_UPHELD  // Some actions reversed
  ESCALATED         // Sent to higher review
}

// Fraud detection rules (configurable)
model FraudRule {
  id                   String    @id @default(uuid())
  name                 String
  description          String?
  category             String    // "velocity", "behavioral", "network", "ml"
  isActive             Boolean   @default(true)

  // Rule definition
  ruleType             String    // "threshold", "pattern", "ml_score"
  ruleConfig           Json      // Rule-specific configuration

  // Thresholds
  warningThreshold     Float?
  blockThreshold       Float?

  // Actions
  autoAction           FraudActionType?
  requiresReview       Boolean   @default(true)

  // Performance tracking
  triggeredCount       Int       @default(0)
  falsePositiveCount   Int       @default(0)
  truePositiveCount    Int       @default(0)

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([category])
  @@index([isActive])
}

// Real-time fraud events
model FraudEvent {
  id                   String    @id @default(uuid())
  sessionId            String?
  userId               String
  ruleId               String?
  eventType            String
  severity             String    // "low", "medium", "high", "critical"

  // Context
  details              Json
  riskScore            Float

  // Processing
  wasActioned          Boolean   @default(false)
  actionTaken          String?
  caseId               String?   // If escalated to a case

  timestamp            DateTime  @default(now())

  // Relations
  session              UserSession? @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([caseId])
}
